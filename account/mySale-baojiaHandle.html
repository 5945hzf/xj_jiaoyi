<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>新疆化学品经营服务平台</title>
    <link rel="stylesheet" href="../css/index.css">
    <link rel="stylesheet" href="../css/myPurchase-enquiryQuote.css">
    <style>
        .mianCont_box,.tabLinkMaxBox{display: none;}
        html,body{width: 100%;background-color: white}
        .topTitle{height: 130px;line-height: 130px;background-color: white;}
        .topTitle>.logo1{height: 100%;}
        .topTitle>.logo1>img{vertical-align: middle;}
        .topTitle>.userTitle{ margin-left: 26px;padding-left: 26px;border-left: 2px solid #f1f1f1;  height: 100px;  line-height: 100px;  margin-top: 18px;  color: #090405;  font-size: 30px;  font-family:MicrosoftYaHei-Bold;  }
        .stateList{background-color: white;padding: 14px 0;}
        .stateList>div{float:left; padding: 2px 6px;  }
        .line{width: 100%; height: 0; min-width: 1229px;border-bottom: 2px solid #e1e1e8;  }
        .footerTop{border-top: 1px solid #e1e1e8;}
        .mainLeft{width: 272px;height: 705px;border: 1px solid #e1e1e8;margin-right: 10px;}
        .mainLeft>.title{height: 50px;line-height: 50px;border-bottom: 1px solid #e1e1e8;padding-left: 21px;}
        .mainLeft>ul{padding-left: 21px;font-size: 14px;}
        .mainLeft>ul>li{margin-top: 20px;}
        .main {
            width: 935px;
        }

        textarea.remark {
            border: 1px solid #e7e7e7;
        }
    </style>
</head>
<script src="../js/jquery-3.2.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/header.js" type="text/javascript" charset="utf-8"></script>
<body style="background:#fff;">
    <div class="topTitle mianCont">
        <a href="../index.html" class="logo1 Lf">
            <img src="../img/cf_logo1.png" alt="">
        </a>
        <div class="userTitle Lf">用户中心</div>
    </div>
    <div class="line"></div>
    <div class="stateList mianCont">
        <div class="first">首页&nbsp;></div>
        <div>用户中心&nbsp;></div>
        <div>销售管理&nbsp;></div>
        <div>收到询盘&nbsp;></div>
        <div class="last"> 询盘处理</div>
    </div>
    <div class="mainAll mianCont" style="margin-bottom: 91px;">
        <div class="mainLeft Lf">
            <div class="title">商品信息</div>
            <ul>
                <script type="text/html" id="leftTpl">
                    <li>
                        <div>供应信息编号：<%=interestId%></div>
                    </li>
                    <li>
                        <div>商品名称：<%=productName%></div>
                    </li>
                    <li>
                        <div>形态：<%=productFormStr%></div>
                    </li>
                    <li>
                        <div>纯度：<%=productPurity%>%</div>
                    </li>
                    <li>
                        <div>规格：<%=productSpecNum%><%=productSpecStr%></div>
                    </li>
                    <li>
                        <div>级别：<%=levelName%></div>
                    </li>
                    <li>
                        <div>厂家/产地：<%=productOrigin%></div>
                    </li>
                    <li>
                        <%if (productCate==1) {%>
                            <div>供应总量：<%=sSum%> 吨</div>
                        <%} else if (productCate==2) {%>
                            <div>供应总量：<%=sSum%> <%=productSpecUnitStr%></div>
                        <%}%>
                    </li>
                    <li>
                        <%if (productCate==1) {%>
                            <div>剩余数量：<%=remain%> 吨</div>
                        <%} else if (productCate==2) {%>
                            <div>剩余数量：<%=remain%> <%=productSpecUnitStr%></div>
                        <%}%>
                    </li>
                    <li>
                        <%if (productCate==1) {%>
                            <div>单价：<%=unitPrice%> 元/吨</div>
                        <%} else if (productCate==2) {%>
                            <div>单价：<%=unitPrice%> 元/<%=productSpecUnitStr%></div>
                        <%}%>
                    </li>
                    <%if (isPublic==0) {%>
                        <li>
                            <div>联系人：<%=sContactName%></div>
                        </li>
                        <li>
                            <div>联系电话：<%=sContactPhone%></div>
                        </li>
                    <%} else if (isPublic==1) {%>
                        <li>
                            <div>联系人：xxxxxx</div>
                        </li>
                        <li>
                            <div>联系电话：xxxxxx</div>
                        </li>
                    <%}%>
                </script>
            </ul>
        </div>
        <div class="main Lf">
            <div class="myPurchase-title clearfix">
                <div class="Lf">我的询盘</div>
            </div>
            <div class="purchaseInfo">
                <script type="text/html" id="rightTopTpl">
                    <div class="top clearfix">
                        <div class="left Lf">
                            <%if (productCate==1) {%>
                                <p>采购数量：<%=sum%> 吨</p>
                            <%} else if (productCate==2) {%>
                                <p>采购数量：<%=sum%> <%=productSpecUnitStr%></p>
                            <%}%>
                            <!--  "invoiceType": 1,  发票类型 1：增值税普通发票 2：增值税专用发票 -->
                            <%if(invoiceType == 1){%>
                                <p>发票类型：增值税普通发票</p>
                            <%}else if(invoiceType == 2){%>
                                <p>发票类型：增值税专用发票</p>
                            <%}else if(invoiceType == 3){%>
                                <p>发票类型：不限</p>
                            <%}%>

                            <p>联系人: <%=contactName%></p>
                        </div>
                        <div class="right Lf">
                            <p>
                                <!-- "paymentMethod": 1,  支付方式 1：现汇 2：承兑汇票 3：现汇+承兑 0：不限 -->
                                <span>支付方式：<i class="yellow"><%=paymentMethodStr%></i></span>
                                <span style="margin-left:125px;">总价：<b style="font-weight:bold;" class="yellow zongjia"><%=total%></b>元</span>
                                <!-- "deliveryType": 1,  交割方式 1：包到 2：自提 -->
                                <span  style="margin-left:170px;">交割方式：<%=deliveryTypeStr%></span>
                                <!-- <%if(deliveryType==1){%>
                                    <span style="margin-left:170px;">交割方式：包到</span>
                                <%}else if(deliveryType==2){%>
                                    <span style="margin-left:170px;">交割方式：自提</span>
                                <%}%> -->
                            </p>
                            <p>手机号码：<%=contactPhone%></p>
                            <p>询盘供应商：<%=companyName%></p>
                        </div>
                    </div>
                    <div class="bottom">
                        <p style="margin-left:18px;">备注：<%=note%></p>
                    </div>
                </script>
            </div>
            <div class="myPurchase-infoHandle">
                <div class="myPurchase-title infoHandleTitle clearfix">
                    <div class="Lf">询盘信息<span>(注：询盘有效时间 2017-07-27 15: 50: 29，超时未处理询盘将会失效)</span></div>
                    <div class="Rt yellow">待处理</div>
                </div>
                <div class="infoHandleCont">
                    <div class="left">
                        <script type="text/html" id="rightBottomTpl">
                            <div>
                                <label for="">* 成交总价:
                                    <input id="totalmoney" type="text" class="input" value="<%=total%>">
                                </label>
                            </div>
                            <div>
                                <%if(paymentMethod == 1){%>
                                    <label for="">* 承兑:
                                        <input id="chengdui" disabled type="text" class="input">
                                    </label>
                                    <div class="xhje">
                                        <p>现汇金额为</p>
                                        <p>￥<i style="font-weight:bold;" class="yellow" id="currenthui"><%=total%></i>元</p>
                                    </div>
                                <%}else if(paymentMethod == 2){%>
                                    <label for="">* 承兑:
                                        <input id="chengdui" type="text" class="input" value="<%=total%>" readonly>
                                    </label>
                                    <div class="xhje">
                                        <p>现汇金额为</p>
                                        <p>￥<i style="font-weight:bold;" class="yellow" id="currenthui">0</i>元</p>
                                    </div>
                                <%}else if(paymentMethod == 3){%>
                                    <label for="">* 承兑:
                                        <input id="chengdui" type="text" class="input">
                                    </label>
                                    <div class="xhje">
                                        <p>现汇金额为</p>
                                        <p>￥<i style="font-weight:bold;" class="yellow" id="currenthui"></i>元</p>
                                    </div>
                                <%}%>
                            </div>
                            <div>
                                <label for="">* 支持账期: 
                                    <div class="input" id="supportzq">
                                        <div class="di">
                                            <input class="radio" name="overTime" value="2" type="radio">是
                                        </div>
                                        <div class="di">
                                            <input class="radio" name="overTime" value="1" type="radio">否
                                        </div>
                                    </div>
                                </label>
                            </div>
                            <div>
                                <label for="">* 账期时间:
                                    <div class="input" id="zqTime">
                                        <div class="di">
                                            <input class="radio" name="receiveTime" value="30" type="radio">30天
                                        </div>
                                        <div class="di">
                                            <input class="radio" name="receiveTime" value="60" type="radio">60天
                                        </div>
                                        <div class="di">
                                            <input class="radio" name="receiveTime" value="90" type="radio">90天
                                        </div>
                                    </div>
                                </label>
                            </div>
                            <div>
                                <label for="">
                                    <span class="Lf">&nbsp;&nbsp;备注:</span>
                                    <div class="input">
                                        <textarea placeholder="有其他说明请在备注中说明(50个字以内)" class="remark" style="width:312px;height:122px;"></textarea>
                                    </div>
                                </label>
                            </div>
                            <div class="scOrder">生成订单</div>
                        </script>
                    </div>
                    <div class="right">
                        <p>若对此询盘不满意, 您可以：</p>
                        <div class="refuseBtn">拒绝</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="../js/footer.js" type="text/javascript" charset="utf-8"></script>
    
    <script src="../js/common.js" type="text/javascript" charset="utf-8"></script>
    <script src="../js/template.js"></script>
    <script>
         $(function(){
            var params = window.location.search.substring(1).split('&');
            for(var i = 0; i<params.length;i++){
                var obj = {};
                var item =params[i].split('=');
                var name = item[0];
                var value = item[1];
                obj[name]=value;
                params[i] = obj
            }
            var interestId=params[0]['interestId']?params[0]['interestId']:'';
            var from = params[1]['from']?params[1]['from']:'';
            
            
            // 获取询盘详情
            getEnquiryInfo(interestId, from)
        })
         // 获取询盘详情
        function getEnquiryInfo(interestId, from){
            $.ajax({
                type:"post",
                url:pubIP+"inquiries/getInquiriesInfoByInterestId",//v1.0
                cache:false,
                dataType: "json",
                headers: {
                    Accept: "application/json; charset=utf-8",
                    token: token
                },
                data: {interestId:interestId},
                success: function(res){
                    console.log(res);
                    if(res.code == 1){
                        if(res.data){

                            res.data.resultTime = new Date(res.data.resultTime).Format("yyyy-MM-dd hh:mm:ss");
                            res.data.myfromPage=from;
                            //渲染左侧
                            var leftTpl = template('leftTpl', res.data);
                            $('.mainLeft.Lf ul').html(leftTpl);
                            // 渲染右侧
                            var rightTopTpl = template('rightTopTpl', res.data);
                            $('.purchaseInfo').html(rightTopTpl);
                            var rightBottomTpl = template('rightBottomTpl', res.data);
                            $('.infoHandleCont>.left').html(rightBottomTpl);

                            // // 询盘供应商：
                            // $('.xunpan_gys').text(res.);

                         //$("#totalmoney").val(res.data.total)

                            // 点击生成订单
                            // 现汇金额
                            var totalMoney=$('#totalmoney').val();
                            var acceptanceTotal=$('#chengdui').val();//承兑金额
                            $('#currenthui').text(Number(res.data.total)-Number(acceptanceTotal));
                                console.log(Number(res.data.total),Number(acceptanceTotal))


                            // 1、改变总金额--现汇金额变化
                            $('#totalmoney').on('input porpertychange', function(){
                                

                                //totalMoney = $('#totalmoney').val()
                                var totalMoney=$('#totalmoney').val();
                                var acceptanceTotal=$('#chengdui').val();//承兑金额
                                $('#currenthui').text(Number(res.data.total)-Number(acceptanceTotal));
                                console.log(Number(res.data.total),Number(acceptanceTotal))

                                $('.zongjia').text($('#totalmoney').val());

                                if(totalMoney.trim()){
                                    if(totalMoney-0 <= acceptanceTotal-0){
                                        $('#chengdui').val(totalMoney);
                                        $('#currenthui').text('0');
                                    }else{
                                        console.log(acceptanceTotal,totalMoney)
                                        $('#currenthui').text(totalMoney-acceptanceTotal);
                                    }
                                    
                                }else{
                                    alert('成交总价不能为空');
                                    return;
                                }
                                
                            });
                            // 2、承兑金额--现汇金额变化
                            // if(res.data.paymentMethod == 2){
                            //     $('#chengdui').val(totalMoney);
                            //     $('#currenthui').text('0');
                            // }
                            //承兑加现汇
                            $('#chengdui').on("input",function () {
                                var totalMoney = $('#totalmoney').val();//总金额
                                var acceptanceTotal=$('#chengdui').val();//承兑金额
                                if(Number(totalMoney)-Number(acceptanceTotal)==0){
                                    alert('现汇价不能都为空');
                                    $('#chengdui').val('');
                                    $('#currenthui').text('');
                                    return;
                                }else if(Number(totalMoney)-Number(acceptanceTotal)<0){
                                    alert('承兑价不能大于总价');
                                    $('#chengdui').val('');
                                    $('#currenthui').text('');
                                    return;
                                }else{
                                    $('#currenthui').text(Number(totalMoney)- Number(acceptanceTotal));
                                }
                            })

                            // 支持账期
                            var debtTermKey='',debtTermValue='';
                            $(document).on('change','input:radio[name="overTime"]',function () {
                                debtTermKey = $(this).val();
                                if(debtTermKey==2){
                                    $('input:radio[name="receiveTime"]').attr('disabled',false);
                                } else {
                                    $('input:radio[name="receiveTime"]').removeAttr('checked').attr('disabled',true);
                                    debtTermValue = '';
                                }
                            })
                            $(document).on('change','input:radio[name="receiveTime"]',function () {
                                debtTermValue = $(this).val();
                            })
                            $('.scOrder').click(function(){
                                var acceptanceTotal=$('#chengdui').val();//承兑金额
                                var note=$('.remark').val(),//总金额
                                    dealTotal=res.data.dealTotal;//成交总价
                                if($('#totalmoney').val().trim()){
                                    dealTotal=totalMoney = $('#totalmoney').val()
                                } else {
                                    alert('成交总价不能为空');
                                    return;
                                }
                                if(!acceptanceTotal && !$('#currenthui').text()){
                                    alert('现汇和承兑价不能都为空');
                                    return;
                                }
                                if(res.data.paymentMethod == 3){
                                    if(acceptanceTotal==0 || acceptanceTotal == "" || acceptanceTotal == null){
                                        alert('承兑价不能都为空');
                                        return;
                                    }
                                }
                                if(!debtTermKey){
                                    alert('请选择支持账期与否');
                                    return;
                                }else{
                                    if(debtTermKey==2){
                                        if(!debtTermValue){
                                            alert("请选择账期时间");
                                            return;
                                        } 
                                    }
                                }
                                toAddTradingOrder(interestId,totalMoney,acceptanceTotal,note,debtTermKey-1,debtTermValue,dealTotal);
                            });
                            // 点击拒绝询价
                            $('.refuseBtn').click(function(){
                                refuseEnquiry(interestId);
                            });
                        } else {
                            // 渲染右侧
                            var rightTopTpl = '<h5 style="font-size:30px;line-height:100px;text-align:center;">暂无数据</h5>';
                            $('.purchaseInfo').html(rightTopTpl);
                        }
                    }
                }
            })
        }
        // 拒绝询价
        function refuseEnquiry(interestId){
            $.ajax({
                type:"post",
                url:pubIP+"inquiries/refuseInquiriesInfo",//v1.0
                cache:false,
                dataType: "json",
                headers: {
                    Accept: "application/json; charset=utf-8",
                    token: token
                },
                data: {interestId:interestId},
                success: function(res){
                    console.log(res);
                    if(res.code == 1){
                        alert('您已成功拒绝询价');
                        window.location.href='./myPurchase-enquiryDetaill.html?interestId='+interestId+'&from=mysale';
                    }
                },
                error: function(err){
                    console.log(err);
                }
            });
        }
        // 生成订单
        function toAddTradingOrder(interestId,totalMoney,acceptanceTotal,note,debtTermKey,debtTermValue,dealTotal){

            $.ajax({
                type:"get",
                url:pubIP+"orderApi/addTradingOrderBySupplyInfo",//v2.0
                cache:false,
                dataType: "json",
                headers: {
                    Accept: "application/json; charset=utf-8",
                    token: token
                },
                data: {
                    interestId:interestId,
                    total: totalMoney,
                    acceptanceTotal: acceptanceTotal,//承兑金额
                    note: note,
                    debtTermKey: debtTermKey,//是否支持支持账期 0 不支持 1 支持
                    debtTermValue: debtTermValue,//账期时间 ，debtTermKey＝1时必传
                    dealTotal: dealTotal
                },
                success: function(res){
                    console.log(res);
                    if(res.code == 1){
                        //alert('您已下订单成功');
                        sessionStorage.setItem('hzf_showPage',"flag_wdbj_dcl");
                        window.location.href="./account.html";

                    }else{
                        alert(res.code);
                    }
                },
                error: function(err){
                    console.log(err);
                }
            });
        }
    </script>
</body>
</html>