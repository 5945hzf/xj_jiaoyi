<!--账户 资金 账务明细-->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Cache-Control" CONTENT="no-cache">
    <meta http-equiv="Pragma" content="no-cache">
    <meta name="format-detection" content="telephone=no" />
    <title>新疆化学品经营服务平台</title>
    <link rel="stylesheet" type="text/css" href="../css/index.css"/>
    <style type="text/css">
        .time>.demo-input{padding-left: 10px; height: 38px; min-width: 129px;width: 129px; line-height: 38px; border: 1px solid #e6e6e6;  background-color: #fff;  border-radius: 2px;}
         .btn{width: 139px;height: 42px;line-height:42px;background-color: #007aff;color: white;text-align: center;border-radius: 5px;margin-left: 14px;}
          html,body{ width: 986px;background-color: white; min-width: 986px;}
         .container{width: 986px;height: 1418px;overflow: hidden;border: 1px solid #f1f1f1;}
         .container>.title{height: 50px;line-height: 50px;padding:0 18px;font-size: 16px;border-bottom: 1px solid #f1f1f1;}
         .head{overflow: hidden;padding: 33px;border-bottom: 1px solid #f1f1f1;    font-size: 14px;color:#282828;}
         .head>.left1{overflow: hidden;margin-left: 34px;margin-right: 25px;}
         .head>.left1>img{float:left;width: 160px;height: 104px;}
         .head>.right1{font-size: 14px;}
         .head>.right1>.top1{margin-bottom: 8px;}
         .head>.right2{margin-right: 21px;font-size: 14px;}
         .head>.right2>.btns{margin-top: 42px;}
         .fast{border-bottom: 1px solid #f1f1f1;padding:0 18px 0 33px;height: 35px;line-height: 35px;font-size: 14px; }
         .fast i{margin-left: 4px;margin-right: 4px;}
         .orderList{padding: 19px 42px ;border-bottom: 1px solid #f1f1f1;overflow: hidden;}
         .orderList>div{height: 15px;font-size: 14px;}
         .orderList>.row{width: 0;border-left: 2px solid #f1f1f1;margin: 2px 20px;}
          /*td,th{padding-left: 49px;}*/
         .table div,.table td{text-align: center;}
         .table tr{border-bottom: 1px solid #f1f1f1;height: 60px;}
         .table tr td{overflow: hidden; vertical-align: middle;}
         .table tr td a{color: #007aff;margin-right:10px; }
         a{color: #007aff;}
        .selec>div>input[type="radio"]{margin-left: 49px;}
        .table tr td a:last-child{margin-right: 5px;}
        
    </style>
</head>
<body>


<div class="container">
    <div class="title">账务明细 <a href="##" style="margin-left: 490px;font-size: 14px;" class="day_excel" >日账单下载</a><a href="##" style="margin-left: 35px;font-size: 14px;" class="month_excel">月账单下载</a> <span class="Rt" style="font-size: 14px;">可用金额：<i class="cashBalance" style="color: #ff7929;">56.00</i>元</span></div>
    <div class="head">
        <div class="selec" style="display: block;overflow: hidden">
            <div class="Lf" style="width: 426px;">
                资&nbsp;金&nbsp;流&nbsp;向&nbsp;:
                <input type="radio" name="flow" value="" style="margin-left: 15px;">所有
                <input type="radio" name="flow" value="D">收入
                <input type="radio" name="flow" value="C">支付
            </div>

            <div class="Lf" style="width: 426px;margin-left: 45px;">
                类&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;型&nbsp;:
                <input type="radio" name="leixing" style="margin-left: 15px" value="0">所有
                <input type="radio" name="leixing" value="15">支付
                <input type="radio" name="leixing" value="23">充值
                <input type="radio" name="leixing" value="11">提现
            </div>
        </div>

        <div class="selec" style="margin-top: 20px;overflow: hidden;">
            <div class="orderNum Lf" style="width: 426px;overflow: hidden;"><span style="height: 38px;line-height: 38px;">商户订单号: </span><input type="text" style="width: 332px;height: 36px;padding-left: 10px;"></div>
            <div class="time Lf" style="margin-left: 45px;width: 426px;overflow: hidden;">
                <span style="height: 38px;line-height: 38px;">起止时间: </span>
                <input type="text" class="demo-input laydate-icon" placeholder="请选择日期" id="test1">
                <span style="height: 38px;line-height: 38px;">&nbsp;-&nbsp; </span>
                <input type="text" class="demo-input laydate-icon" placeholder="请选择日期" id="test2">
            </div>
        </div>
        <div class="btn sousuo" style="margin-top: 30px;height: 42px; line-height: 42px;width: 240px;margin-left: 0;">搜索</div>


    </div>
    <div class="fast">收入(0)：
    		<i style="color: #3ebc28;">0.00</i>元
    		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;支出(0)：
    		<i style="color: #ff342e;">-0.00</i>元 <a href="##" class="Rt downWd" >下载账单</a></div>


    <table class="table" border="1"  width="985px" align="center" style="font-size: 12px;color: #282828;">
        <thead>
            <tr style="height: 35px;line-height: 35px;background-color: #fdfdfd;">
                <th>时间</th>
                <th>流水号 | 商户订单号</th>
                <th>类型</th>
                <th>交易对方</th>
                <th>收入/支出(元)</th>
                <th>余额(元)</th>
                <th>详情</th>
                <th>回执单</th>
            </tr>
        </thead>
      <!--  <tbody class="my_tbody">

       </tbody> -->
       <tbody class="myTbody">
            
       </tbody>
       
    </table>
    <div class="myPage" style="text-align: center;margin-top: 29px;">
        <ul class="pagination" id="page1" style="position: static;margin-bottom: 0;"></ul>
        <div class="pageJump">
            <span class="allPageN">1/200</span>
            <i style="margin-left: 12px;">共200页</i>，
            <span>到第</span>
            <input type="text"/>
            <span>页</span>
            <button type="button" class="button">GO</button>
        </div>
    </div>

   <!--  <div id="Pagination" class="pagination"><!-- 这里显示分页 --></div> -->

</div>



<script src="../js/pager.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/jquery-3.2.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="./laydate/laydate.js"></script> <!-- 改成你的路径 -->
<script src="../js/common.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript">
    laydate({
        elem: '#test1'
    })
    laydate({
        elem: '#test2',
        choose: function(date){ //选择好日期的回调
            // console.log(date);
            if (date < $('#test1').val()) {
                cf_alert1(2, '开始时间不能大于结束时间');
                $('#test2').val('');
            }

            var time1 = new Date().Format("yyyy-MM-dd");

            if (date > time1) {
                cf_alert1(2, '结束时间不能超过今天时间');
                $('#test2').val(time1);
            }
        }
    })
    laydate.skin('yahui');  //加载皮肤，参数lib为皮肤名

    // 资金账户余额
    $.ajax({
        type:"get",
        headers: {
            Accept: "application/json; charset=utf-8",
            token: token
        },
        url: pubIP+"financialApi/getBalanceOfCompany",//v1.0
        cache:false,
        data:{
        },
        dataType: "json",
        success: function(response){
            console.log(response);
            if(response.code == 1){
                $('.cashBalance').text(response.data);
            }
        }   
    });

    //搜索
    $('.sousuo').click(function () {
        var flow = $('input[name="flow"]:checked').val();

        var leixing = $('input[name="leixing"]:checked').val();

        var orderNum = $('.orderNum input').val();

        var startTime = $('#test1').val();
        var endTime = $('#test2').val();

        
        if (startTime == '' || endTime == '') {
            var timeSlot = '';
        } else {
            var timeSlot = 4;
        }

        listPage(1, flow, leixing, orderNum, startTime, endTime, timeSlot);
    });

    //账务明细接口－中信银行接口V1.0------暂无数据

    listPage(1, '', '', '', '', '', '');
    function listPage(currentPage, flow, leixing, orderNum, startTime, endTime, timeSlot){
        $.ajax({
            type:"get",
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            url: pubIP+"financialApi/getFinancialList",
            cache:false,
            data:{
                moneyFlow: flow,//资金流向 D收入； C 支出
                tranType: leixing,//交易类型 0 所有 ； 15 现金交易 ； 23 充值 ； 11 提现；
                orderId: orderNum,//订单编号
                startTime: startTime,//开始时间，timeSlot＝4时必填
                endTime: endTime,//结束时间 ，timeSlot＝4时必填
                timeSlot: timeSlot,//起止时间类型 1当天，2最近一周 ，3 最近一个月 4 自选时间段
            },
            dataType: "json",
            success: function(response){
                console.log('账务明细', response);
                if(response.code == 1){
                    // 收入金额
                    var income = response.data.countData.income;
                    // 收入笔数
                    var incomeNum = response.data.countData.incomeNum;
                    // 支出金额
                    var expend = response.data.countData.expend;
                    // 支出金额笔数
                    var expendNum = response.data.countData.expendNum;
                    $('.fast').html('收入('+ incomeNum +')：<i style="color: #3ebc28;">'+ income +'</i>元'+
                                '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;支出('+ expendNum +')：<i style="color: #ff342e;">-'+ expend +'</i>元'+
                                '<a href="##" class="Rt downWd">下载账单</a>');
                    //TODO-----------
                    var list = response.data.pageData;
                    var str = '';
                    if(list.length==0){ $(".myTbody").html("");$(".pagination").parent().css("display","none"); return;}
                    $(".pagination").parent().css("display","block");
                    if(currentPage==1){
                        //修改底部分页
                        var pageNum=Math.ceil(list.length/10);
                        $(".allPageN").attr("pageTotal",pageNum);
                        $(".pageJump i").text("共"+pageNum+"页");
                        $('.objListBox>div:nth-child(5n)').css('margin-right','0');
                        Page({
                            num: pageNum,
                            elem: $('#page1'),
                            callback: function(n) {
                                // console.log(n);
                                listPage(n);//加载n页数据
                            }
                        });
                    }
                    // 修改底部页数
                    $(".allPageN").text((currentPage)+"/"+ $(".allPageN").attr("pageTotal"));
                    
                    $.each(list,function(idx,item){
                        //首次请求时 改变分页数据
                    
                        if(idx<(currentPage-1)*10){
                            return;
                        } 

                        if(idx>=currentPage*10){
                            return;
                        }  

                        str+='<tr>'
                        str+='<td>'
                        str+='<div>'+item.TRANDATE+'</div>'
                        str+='<div>'+item.TRANTIME+'</div>'
                        str+='</td>'
                        str+='<td>'
                        str+='<div>流水号：'+item.HOSTFLW+'</div>'
                        if (item.HOSTSEQ != null) {
                            str+='<div>订单号：'+item.HOSTSEQ+'</div>'
                        }
                        
                        str+='</td>'
                        if(item.TRANTYPE==11){
                            str+='<td style="margin-top: 27px;">提现</td>'
                        }else if(item.TRANTYPE==15){
                            str+='<td style="margin-top: 27px;">现汇交易</td>'
                        }else if(item.TRANTYPE==23){
                            str+='<td style="margin-top: 27px;">充值</td>'
                        }
                        str+='<td class="user">'
                        str+='<div>账户名：'+item.OPPACCNAME+'</div>'
                        str+='<div>账户号：'+item.OPPACCNO+'</div>'
                        str+='</td>'
                        if(item.CDFG=="D"){
                            str+='<td>-'+item.TRANAMT+'</td>'
                        }else if(item.CDFG=="C"){
                            str+='<td>+'+item.TRANAMT+'</td>'
                        }
                        str+='<td>'+item.ACCBAL+'</td>'
                        if (item.TRANTYPE == 11 || item.TRANTYPE == 23) {
                            str+='<td><a style="color: #333; cursor:default;" href="##">查看</a></td>'
                        } else {

                            str+='<td><a href="./mySale-orderDetailStatus.html?userType='+item.type+'&id='+item.HOSTSEQ+'">查看</a></td>'
                        }
                        
                        if (item.HOSTSEQ != null) {
                            str+='<td><a class="upload_btn" data-orderId="'+item.HOSTSEQ+'" onclick="down_moban(this)" href="##">下载</a></td>'
                        } else {
                            str+='<td><a class="upload_btn" href="##" style="color: #333; cursor:default;">下载</a></td>'
                        }
                        

                        str+='</tr>'
                    })
                    $(".myTbody").html(str);

                }
            }
        });
    }

    //月账单下载  
    $(document).on('click', '.month_excel', function () {
        $(this).attr('download', pubIP + "financialApi/downExcel?token="+token+"&timeSlot=3")
        $(this).attr('href', pubIP + "financialApi/downExcel?token="+token+"&timeSlot=3");
    });
    
    //日账单下载  
    $(document).on('click', '.day_excel', function () {
        // excel(1);
        $(this).attr('download', pubIP + "financialApi/downExcel?token="+token+"&timeSlot=1")
        $(this).attr('href', pubIP + "financialApi/downExcel?token="+token+"&timeSlot=1");
    });

    //下载账单
    $(document).on('click', '.downWd', function () {
        // excel('');
        $(this).attr('download', pubIP + "financialApi/downExcel?token="+token+"&timeSlot=")
        $(this).attr('href', pubIP + "financialApi/downExcel?token="+token+"&timeSlot=");

    });

    // function excel(timeSlot) {
    //     $.ajax({
    //         url: pubIP + 'financialApi/downExcel',
    //         type: 'get',
    //         dataType: 'json',
    //         headers: {
    //             // Accept: "application/json; charset=utf-8",
    //             token: token
    //         },
    //         data: {
    //             timeSlot: timeSlot
    //         },
    //         success: function (data) {
    //             console.log(data);
                
    //         },
    //         error: function (err) {
    //             console.log(err);
    //         }
    //     });
    // }


    //下载回执单 
    function down_moban(that){
        console.log($(that).attr('data-orderId'));
        var orderId = $(that).attr('data-orderId')
        $.ajax({
            url: pubIP + 'financialApi/getReceipts?orderId='+orderId,
            type: 'get',
            dataType: 'json',
            headers: {
                Accept: "application/json; charset=utf-8",
                token: token
            },
            success: function (data) {
                console.log(data);
                var thisUrl = data.dataN;
                openWin("../generic/web/viewer.html?thisUrl="+thisUrl);
            },
            error: function (err) {
                console.log(err);
            }
        })
    }
    function openWin(url) {
        $('body').append($('<a href="' + url + '" target="_blank" id="openWin"></a>'))
        document.getElementById("openWin").click();//点击事件
        $('#openWin').remove();
    }

   
</script>
</body>
</html>
