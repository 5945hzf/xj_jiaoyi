<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Cache-Control" CONTENT="no-cache">
    <meta http-equiv="Pragma" content="no-cache">
    <meta name="format-detection" content="telephone=no" />
	<title adct1="1">新疆化学品经营服务平台</title>
	<link rel="stylesheet" type="text/css" href="../css/index.css"/>
	<link rel="stylesheet" type="text/css" href="../css/home.css"/>
	<link rel="stylesheet" type="text/css" href="../css/common.css"/>
	<link rel="stylesheet" type="text/css" href="../css/activityCenter/addActivityShop.css">
</head>
<style>
	.selectPub {
		margin-left: 4px;
		float: left;
		line-height: 37px;
	}
</style>
<body>

	<!-- 活动列表-添加商品 -->
	<div class="addActivityShop">
		<div class="addActivityShopTitle">
			<span>添加活动商品</span>
		</div>
		<div class="margin_auto">
			<div class="div_one">
				<div class="inline-block title">
					<span>活动名称：</span>
				</div>
				<div class="inline-block">
					<span class="activityTitle"></span>
				</div>
			</div>
			<div class="div_one">
				<div class="inline-block title">
					<span>活动开始时间：</span>
				</div>
				<div class="inline-block">
					<span class="activityStartTime">2018年4月1日 13:00:02</span>
				</div>
			</div>
			<div class="div_one">
				<div class="inline-block title">
					<span>活动结束时间：</span>
				</div>
				<div class="inline-block">
					<span class="activityEndTime">2018年4月1日 13:00:02</span>
				</div>
			</div>
			<div class="div_one select clearfix">
				<div class="inline-block title fl">
					<span class="red">*</span>
					<span style="line-height: 37px;">选择商品：</span>
				</div>
				<div class="selectPub select_shop fl inline-block" data-selectedindex="0">
			        <span></span>
			        <img src="../img/prl-select.jpg" alt="">
			        <ul>
			            <li data-index="1">10</li>
			            <li data-index="2">20</li>
			            <li data-index="3">30</li>
			        </ul>
			    </div>
			    <span onclick="goAddGoods()" style="color: #00a0e9;width: 76px;cursor: pointer; display: inline-block; line-height: 37px; margin-left: 10px;">添加商品</span>
			    <span class="ts fl"></span>
			</div>
			<div class="div_one">
				<div class="inline-block title">
					<span>商品纯度：</span>
				</div>
				<div class="inline-block">
					<span class="purity"></span>
				</div>
				<span class="ts"></span>
			</div>
			<div class="div_one">
				<div class="inline-block title">
					<span>商品级别：</span>
				</div>
				<div class="inline-block">
					<span class="level"></span>
				</div>
				<span class="ts"></span>
			</div>
			<div class="div_one">
				<div class="inline-block title">
					<span>商品规格：</span>
				</div>
				<div class="inline-block">
					<span class="guige"></span>
				</div>
				<span class="ts"></span>
			</div>
			<div class="div_one">
				<div class="inline-block title">
					<span class="red">*</span>
					<span>活动商品名称：</span>
				</div>
				<div class="inline-block">
					<input type="text" class="activity_shop_name" name="">
				</div>
				<span class="ts"></span>
			</div>
			<div class="div_one">
				<div class="inline-block title">
					<span class="red">*</span>
					<span>单价：</span>
				</div>
				<div class="inline-block">
					<input type="number" class="unit" name="">
					<span class="unit_money">元</span>
				</div>
				<span class="ts"></span>
			</div>
			<div class="div_one">
				<div class="inline-block title">
					<span class="red">*</span>
					<span>最小起订单量：</span>
				</div>
				<div class="inline-block">
					<input type="number" class="order_num" name="">
				</div>
				<span class="ts"></span>
			</div>
			<div class="div_one">
				<div class="inline-block title">
					<span class="red">*</span>
					<span>最大购买量：</span>
				</div>
				<div class="inline-block">
					<input type="number" class="buy_num" name="">
				</div>
				<span class="ts"></span>
			</div>
			<div class="div_one">
				<div class="inline-block title">
					<span class="red">*</span>
					<span>库存：</span>
				</div>
				<div class="inline-block">
					<input type="number" class="kucun" name="">
				</div>
				<span class="ts"></span>
			</div>
			<div class="div_one">
				<div class="inline-block title">
					<span class="red">*</span>
					<span>支付方式：</span>
				</div>
				<div class="inline-block">
					<!-- <input type="radio" name="pay_method" checked="" value='1'>现汇
					<input type="radio" name="pay_method" value='2'>承兑
					<input type="radio" name="pay_method" value='3'>现汇+承兑 -->
					<input type="checkbox" name="pay_method" value="1" style="cursor: pointer;" /><label for="xianhui" style="margin-right: 40px;">现汇</label>
					<input type="checkbox" name="pay_method" value="2" style="cursor: pointer;"/><label for="chengdui" style="margin-right: 40px;">承兑</label>
					<input type="checkbox" name="pay_method" value="3" style="cursor: pointer;"/><label for="xjiac">现汇+承兑</label>
				</div>
			</div>
			<div class="div_one">
				<div class="inline-block title">
					<span class="red">*</span>
					<span>联系人：</span>
				</div>
				<div class="inline-block">
					<input type="text" class="concat_name" name="">
				</div>
				<span class="ts"></span>
			</div>
			<div class="div_one">
				<div class="inline-block title">
					<span class="red">*</span>
					<span>联系方式：</span>
				</div>
				<div class="inline-block">
					<input type="text" class="concat_method" name="">
				</div>
				<span class="ts"></span>
			</div>
			<div class="div_one clearfix">
				<div class="inline-block fl title">
					<span class="red">*</span>
					<span>商品活动主图：</span>
				</div>
				<div class="inline-block fl">
					<div class="upload_img inline-block">
						<input type="file" name="file" id="file0" class="inputfile" /> 
						<input type="hidden"  value="" />
					</div>
				</div>
				<span class="ts" style="margin-top: 85px; line-height: 16px; display: inline-block;"></span>
			</div>
			<div class="div_one clearfix">
				<div class="inline-block fl title">
					<span class="red">*</span>
					<span>商品图片：</span>
				</div>
				<div class="inline-block fl img1">
					<div class="fl">
						<div class="upload_img inline-block fl"><input type="file" name="file" class="inputfile file" id="file1"/> 
						<input type="hidden"  value="" /></div>
						<div class="upload_img inline-block fl"><input type="file" name="file" class="inputfile file" id="file2"/> 
						<input type="hidden"  value="" /></div>
						<div class="upload_img inline-block fl"><input type="file" name="file" class="inputfile file" id="file3"/> 
						<input type="hidden"  value="" /></div>
						<div class="upload_img inline-block fl"><input type="file" name="file" class="inputfile file" id="file4"/>
						<input type="hidden"  value="" /></div>
						<div class="upload_img inline-block fl"><input type="file" name="file" class="inputfile file" id="file5"/>
						<input type="hidden"  value="" /></div>
						<div class="upload_img inline-block fl"><input type="file" name="file" class="inputfile file" id="file6"/>
						<input type="hidden"  value="" /></div>
					</div>
				</div>
			</div>
			<div class="div_one">
				<div class="submit_btn">提交</div>
			</div>
		</div>
	</div>
	<script src="../js/jquery-3.2.1.min.js"></script>
    <script src="../js/common.js"></script>
	<!-- <script src="http://static.runoob.com/assets/jquery-validation-1.14.0/dist/jquery.validate.min.js"></script>
	<script src="http://static.runoob.com/assets/jquery-validation-1.14.0/dist/localization/messages_zh.js"></script>
	 -->
    <script type="text/javascript">

    	var activityId = window.sessionStorage.getItem('activityId');
    	var activityTitle = window.sessionStorage.getItem('activityTitle');
		var startTime = window.sessionStorage.getItem('startTime');
		var endTime = window.sessionStorage.getItem('endTime');

		var type = sessionStorage.getItem('qiang_gou_huo');

		var productId = window.sessionStorage.getItem('productId');

		if (startTime) {
			startTime = startTime.replace('-', '年');
			startTime = startTime.replace('-', '月');
			startTime = startTime.replace(' ', '日 ');
		}
		
		if (endTime) {
			endTime = endTime.replace('-', '年');
			endTime = endTime.replace('-', '月');
			endTime = endTime.replace(' ', '日 ');
		}
		

		$('.activityTitle').text(activityTitle);
		$('.activityStartTime').text(startTime);
		$('.activityEndTime').text(endTime);

		shop_list('');

		function goAddGoods() {
            sessionStorage.setItem('hzf_showPage',"hzf_fbsp");
			window.parent.location.href="../account/account.html"
        }

		function shop_list(cont) {
			$.ajax({
				type: "get",
	            url: pubIP + "acticityApi/getStoreProduct",//v1.0
	            headers: {
	                token: token
	            },
	            cache: false,
	            async:false,
	            data: {
	            	companyId: companyId,
	            	cont: cont
	            },
	            dataType: "json",
	            success: function(data){
					console.log(data);

					//所有商品
					if (data.code == 1) {
						if (cont == '') {
							if (data.data.length != 0) {
								var str = '';
								for (var i = 0; i < data.data.length; i++) {
									
									str += '<li data-index="'+data.data[i].sProductId+'" data-purity="'+data.data[i].purity+'" data-productLevel="'+data.data[i].productLevel+'" data-spec="'+data.data[i].spec+'" data-productSpecUnitStr="'+data.data[i].productSpecUnitStr+'">'+data.data[i].productName+'</li>';
										
								}

								$('.select_shop ul').html(str);

								$('.select_shop ul li').click(function(){
								    event.stopPropagation();
								    $(this).parent().parent().attr('data-selectedindex', $(this).attr('data-index'));
								    $(this).parent().parent().find('span').text($(this).text());
								    $(this).parent().parent().children('img').attr('src', '../img/prl-select.jpg')
								    $(this).parent().css('display','none');

								    $('.select_shop').next().text('');

								    $('.purity').text($(this).attr('data-purity')+'%');
								    console.log($(this).attr('data-productLevel') == 'null');
								    $('.level').text($(this).attr('data-productLevel') == 'null' ? '' : $(this).attr('data-productLevel'));
								    $('.guige').text($(this).attr('data-spec')+$(this).attr('data-productSpecUnitStr'));

								    $('.activity_shop_name').val($(this).text());

								});
									
							}
							
						}
					}

				},
				error: function(err) {
					console.log(err);
				}
			});
		}


		if (productId) {
			$.ajax({
	        	type: "get",
	            url: pubIP + "acticityApi/getStoreProductById",//v1.0
	            headers: {
	                token: token
	            },
	            cache: false,
	            async:false,
	            data: {
	            	companyId: companyId,
	            	activityId: activityId,
	            	productId: productId
	            },
	            dataType: "json",
	            success: function(data){
					console.log(data);

					$('.select_shop span').text(data.data[0].productName);
					$('.select_shop').attr('data-selectedindex', data.data[0].productId);
					
					$('.purity').text(data.data[0].purity+'%');
					$('.level').text(data.data[0].productLevel);  
					$('.guige').text(data.data[0].productSpec);  

					$('.activity_shop_name').val(data.data[0].productName);  
					$('.unit').val(data.data[0].unitPrice);  
					$('.order_num').val(data.data[0].minAmount);  
					$('.buy_num').val(data.data[0].maxAmount);  
					$('.kucun').val(data.data[0].repertory);  

					// $('input[name="pay_method"][value="'+data.data[0].paymentMethod+'"]').attr('checked',true);

					var methodArr = String(data.data[0].paymentMethod).split('');
	                for (i in methodArr) {
	                	$('input[name="pay_method"][value="'+methodArr[i]+'"]').attr('checked','true');
	                }

					$('.concat_name').val(data.data[0].contactName);  
					$('.concat_method').val(data.data[0].contactPhone);  

					var pic = data.data[0].pics.split(',');

					console.log(pic);

					for (var i = 0; i < pic.length; i++) {
						$('#file'+i).next().val(pic[i]);

						if (pic[i]) {
							$('#file'+i).parent().css('background', 'url('+pic[i]+') center center / contain no-repeat');
						}
						
					}

					
				},
	            error: function(err) {
	            	console.log(err);
	            }
	        });

		}


		//ele: 某个元素   word: 显示文字  
		function ts_block(ele, word) {
			
			if (ele.attr('type') == 'text' || ele.attr('type') == 'number') {
				ele.parent().parent().find('.ts').text(word);
				ele.focus();
			} else {
				ele.parent().find('.ts').text(word);
			}
			ele.parent().find('.ts').show();
		}

		var ind = 0;


		$('.submit_btn').unbind();
		$('.submit_btn').click(function() {
			
			$(this).attr('data-submitFlag', '1');

			var select_shop = $('.select_shop');
			var activity_shop_name = $('.activity_shop_name');
			var unit = $('.unit');
			var order_num = $('.order_num');
			var buy_num = $('.buy_num');
			var kucun = $('.kucun');
			var concat_name = $('.concat_name');
			var concat_method = $('.concat_method');

			
			
			if (select_shop.find('span').text() == '') {
				ts_block(select_shop, '请选择商品');
				return false;
			}

			if (activity_shop_name.val() == '') {
				ts_block(activity_shop_name, '活动商品名称不能为空');
				return false;
			}

			if (unit.val() == '') {
				ts_block(unit, '单价不能为空');
				return false;
			}

			if (order_num.val() == '') {
				ts_block(order_num, '最小起订单量不能为空');
				return false;
			}

			if (buy_num.val() == '') {
				ts_block(buy_num, '最大购买量不能为空');
				return false;
			}

			if (Number(buy_num.val()) < Number(order_num.val())) {
				ts_block(buy_num, '最大购买量不能小于最小起订单量');
				return false;
			}

			if (kucun.val() == '') {
				ts_block(kucun, '库存不能为空');
				return false;
			}

			if (concat_name.val() == '') {
				ts_block(concat_name, '联系人不能为空');
				return false;
			}

			if (concat_method.val() == '') {
				ts_block(concat_method, '联系方式不能为空');
				return false;
			} else if (!(/^1(3|4|5|6|7|8|9)\d{9}$/.test(concat_method.val()))) {
				ts_block(concat_method, '联系方式格式不正确');
				return false;
			}

			var sProductId = select_shop.attr('data-selectedindex');
			var productName = select_shop.find('span').text();

			// var paymentMethod = $('input[name="pay_method"]:checked').val();

			var obj = $('input[type="checkbox"]');
        	var check_val = [];
        	for (i in obj) {
        		if (obj[i].checked) {
        			check_val.push(obj[i].value);
        		}
        	}
        	var checkstr = check_val.join('');
        	// console.log(checkstr);
			


			var pics = '';
			
			$('input[type="hidden"]').each(function() {

				if ($(this).attr('value') != '') {
					ind++;
					pics += $(this).val() + ',';
				}
				
			});	

			if (ind < 6) {
				$('#file0').parent().parent().next().text('图片不能少于6张').show();
				return false;
			} else {
				$('#file0').parent().parent().next().text('').hide();
			}

			if (productId) {
				$.ajax({
					type: "post",
		            url: pubIP + "acticityApi/updateActivityProduct",//v1.0
		            headers: {
		                token: token
		            },
		            cache: false,
		            data: {
		            	activityId: activityId,
		            	sProductId: sProductId,
		            	type: type,
		            	companyId: companyId,
		            	productName: productName,
		            	unitPrice: unit.val(), //单价
		            	minAmount: order_num.val(), //最小购买量
		            	maxAmount: buy_num.val(),//最大购买量
		            	repertory: kucun.val(), //库存
		            	paymentMethod: checkstr,
		            	contactName: concat_name.val(),
		            	contactPhone: concat_method.val(),
		            	pics: pics
		            },
		            dataType: "json",
		            success: function(data){
						console.log(data);

						if (data.code == 1) {

							// cf_alert1(1, '修改成功');
							window.location.href = 'activityList.html';
							
						} else {
							
							cf_alert1(2, '修改失败');
							
						}
					},
					error: function(err) {
						console.log(err);
					}

				});
			} else {
				$.ajax({
					type: "post",
		            url: pubIP + "acticityApi/addActivityProduct",//v1.0
		            headers: {
		                token: token
		            },
		            cache: false,
		            data: {
		            	activityId: activityId,
		            	sProductId: sProductId,
		            	type: type,
		            	companyId: companyId,
		            	productName: productName,
		            	unitPrice: unit.val(), //单价
		            	minAmount: order_num.val(), //最小购买量
		            	maxAmount: buy_num.val(),//最大购买量
		            	repertory: kucun.val(), //库存
		            	paymentMethod: checkstr,
		            	contactName: concat_name.val(),
		            	contactPhone: concat_method.val(),
		            	pics: pics
		            },
		            dataType: "json",
		            success: function(data){
						console.log(data);

						if (data.code == 1) {

							cf_alert1(1, '添加成功');
							window.location.reload();
							
						} else {

							cf_alert1(2, '添加失败');
						}
					},
					error: function(err) {
						console.log(err);
					}

				});
			}

			

		});




		$('.activity_shop_name').blur(function() {
			if ($(this).val() == '') {
				$(this).parent().parent().find('.ts').text('活动商品名称不能为空');
			} else {
				$(this).parent().parent().find('.ts').text('');
			}
		});

		$('.unit').blur(function() {
			if ($(this).val() == '') {
				$(this).parent().parent().find('.ts').text('单价不能为空');
			} else {
				$(this).parent().parent().find('.ts').text('');
			}
		});

		$('.order_num').blur(function() {
			if ($(this).val() == '') {
				$(this).parent().parent().find('.ts').text('最小起订单量不能为空');
			} else {
				$(this).parent().parent().find('.ts').text('');
			}
		});

		$('.buy_num').blur(function() {
			if ($(this).val() == '') {
				$(this).parent().parent().find('.ts').text('最大购买量不能为空');
			} else if (Number($(this).val()) < Number($('.order_num').val())) {
				console.log($(this).val());
				console.log($('.order_num').val());
				$(this).parent().parent().find('.ts').text('最大购买量不能小于最小起订单量');
			} else {
				$(this).parent().parent().find('.ts').text('');
			}
		});

		$('.kucun').blur(function() {
			if ($(this).val() == '') {
				$(this).parent().parent().find('.ts').text('库存不能为空');
			} else {
				$(this).parent().parent().find('.ts').text('');
			}
		});

		$('.concat_name').blur(function() {
			if ($(this).val() == '') {
				$(this).parent().parent().find('.ts').text('联系人不能为空');
			} else {
				$(this).parent().parent().find('.ts').text('');
			}
		});

		$('.concat_method').blur(function() {
			if ($(this).val() == '') {
				$(this).parent().parent().find('.ts').text('联系方式不能为空');
			} else if (!(/^1(3|4|5|6|7|8|9)\d{9}$/.test($(this).val()))) {
				$(this).parent().parent().find('.ts').text('联系方式格式不正确');
			} else {
				$(this).parent().parent().find('.ts').text('');
			}
		});

    	
    	$(document).on('change','#file0,#file1,#file2,#file3,#file4,#file5,#file6',function(){
			xmTanUploadImg1(this);
		})
		
    	var ind_pic = 0;

		function xmTanUploadImg1(obj) {
	        var file = obj.files[0];
	        if (file.size >= 2097152) {
	            alert('上传的图片超过了2MB');
	            return;
	        }
	
	        var formdata=new FormData();
	
	        formdata.append('file', file);
	        
	        $.ajax({
	            url: uplodImgPath,
	            type: 'post',
	            processData: false,  // 告诉jQuery不要去处理发送的数据
	            contentType: false,   // 告诉jQuery不要去设置Content-Type请求头
	            data: formdata,
	            cache: false,
	            dataType: 'json',
	            success: function (data) {
	                //console.log(data);
	                $(obj).parent().css({
	                		'background':'url('+data.url+') no-repeat',
	                		'background-position':'center',
	                		'background-size':'contain',
	                		'background-color':'#f6f6f6'
	                });
	                $(obj).parent().find('input[type="hidden"]').val(data.url);
	 

					ind_pic++;

					if ($('.submit_btn').attr('data-submitFlag') == '1') {
	                	if (ind_pic < 6) {
							$('#file0').parent().parent().next().text('图片不能少于6张').show();
						} else {
							$('#file0').parent().parent().next().text('').hide();
						}	
	                }

	                

	            },
	            error: function (err) {
	                console.log(err);
	            }
	        });
	
	    }

    </script>
</body>
</html>